name: CMake on a single platform

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake make gcc g++ libboost-all-dev && sudo add-apt-repository ppa:borglab/gtsam-release-4.0 && sudo apt install libgtsam-dev libgtsam-unstable-dev libpcl-dev libopencv-dev

      - name: Install open3D
        run: wget -c https://github.com/intel-isl/Open3D/releases/download/v0.12.0/open3d-app-0.12.0-Ubuntu_20.04.deb && sudo apt-get install ./open3d-app-0.12.0-Ubuntu_20.04.deb
        # Add other dependencies if required

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}

      - name: Build
        run: cmake --build build --config ${{env.BUILD_TYPE}}

      - name: Test
        working-directory: build
        run: ctest -C ${{env.BUILD_TYPE}} --output-on-failure # Adds verbosity to show failing test output
